<!DOCTYPE HTML>
<html>
<head>
<title>CN Chat App</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js" integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ==" crossorigin="anonymous"></script>
<script>
    Date.prototype.format = function(fmt) {
     var o = {
        "M+" : this.getMonth()+1,                 //月份
        "d+" : this.getDate(),                    //日
        "h+" : this.getHours(),                   //小时
        "m+" : this.getMinutes(),                 //分
        "s+" : this.getSeconds(),                 //秒
        "q+" : Math.floor((this.getMonth()+3)/3), //季度
        "S"  : this.getMilliseconds()             //毫秒
    };
    if(/(y+)/.test(fmt)) {
            fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));
    }
     for(var k in o) {
        if(new RegExp("("+ k +")").test(fmt)){
             fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
         }
     }
    return fmt;
}
</script>
<script type="text/javascript" charset="utf-8">
    // function loadXMLDoc()
    // {
    //     var req = new XMLHttpRequest()
    //     req.onreadystatechange = function()
    //     {
    //         if (req.readyState == 4)
    //         {
    //             if (req.status != 200)
    //             {
    //                 //error handling code here
    //             }
    //             else
    //             {
    //                 var response = JSON.parse(req.responseText)
    //                 document.getElementById('myDiv').innerHTML += "<p>"+response.time+"</p>"+response.username+"<br>"
    //                 document.getElementById('scname').value = ''
    //             }
    //         }
    //     }

    //     req.open('POST', '/ajax')
    //     req.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
    //     var time = new Date().format("yyyy-MM-dd hh:mm:ss")
    //     var un = document.getElementById('scname').value
    //     var postVars = 'username='+un+"&time="+time   //This is the request you send to the server
    //     req.send(postVars)

    //     return false
    // }
    var socket = io.connect("http://127.0.0.1:5000");
    function enter_room(rid) {
        socket.emit('enter room', {'rid': rid})
    }

    function back() {
        document.getElementById("auth").style.display = "none"
        document.getElementById("whole_system").style.display = 'inline'
    }

    function into() {
        authpassword = document.getElementById('authpassword').value
        authrid = document.getElementById('authrid').value
        socket.emit('please auth', {'authpassword': authpassword, 'authrid': authrid})
    }

    function exit() {
        socket.emit('exit room', {'rid': document.getElementById('rid').value})
    }
    
    $(document).ready(function() {

        socket.on('connection', function() {
            socket.emit('connection', {'data': 'I\'m connected!'});
        });

        socket.on('connection success', function(msg) {
            username = msg;
            document.getElementById("hello").innerHTML = "<h2>"+"Hello, "+msg+"!"+"</h2>";
            document.getElementById("welcome").innerHTML = "<h2>Welcome " + msg + "!</h2>";
        })

        socket.on('my response', function(msg) {
            document.getElementById("myDiv").innerHTML += "<p>" + msg.name + " at " + msg.time + "</p>" + msg.data + "<br>";
            document.getElementById('scname').value = ''
            // $('#log').append('<br>' + $('<div/>').text('Received #' + msg.count + ': ' + msg.data).html());
        });

        socket.on('room response', function(msg) {
            document.getElementById("room_box").innerHTML += "<p>" + msg.name + " at " + msg.time + "</p>" + msg.data + "<br>";
            document.getElementById('room_text').value = ''
        })

        $('#emit').submit(function(event) {
            //console.log(document.getElementById("scname").value);
            socket.emit('my event', {'data': document.getElementById("scname").value, 'time': new Date().format("yyyy-MM-dd hh:mm:ss")});
            return false;
        });

        $('#room_emit').submit(function(event) {
            socket.emit('room chatting', {'msg': document.getElementById("room_text").value, 'room': document.getElementById('rid').value, 'time': new Date().format("yyyy-MM-dd hh:mm:ss")});
            return false;
        })

        $('#create').submit(function(event) {
            room_name = document.getElementById("room_name").value;
            room_description = document.getElementById("description").value;
            room_password = document.getElementById("room_password").value;
            socket.emit('create room', {'name': room_name, 'description': room_description, "password": room_password})
            return false;
        })

        socket.on('new room', function(msg) {
            document.getElementById("chatting_room").innerHTML = "<h3>Current Chatting Rooms:</h3>";
            var length = msg.existing_rooms_names.length;
            document.getElementById('chatting_room').innerHTML += '<ul>';
            for (var i=0; i<length; i++) {
                document.getElementById('chatting_room').innerHTML += "<li> <button onclick=enter_room(" + msg.existing_rooms_ids[i]
                + ")>"+ msg.existing_rooms_names[i] + "</button>" + "<br>" + "Creator:" + msg.creator[i] + "<br>"+ msg.existing_rooms_descriptions[i] + "<br>" + msg.type[i]
            }
            document.getElementById('chatting_room').innerHTML += '</ul>';
        });
        
        socket.on('auth', function(msg) {
            document.getElementById('authrid').value = msg.rid
            document.getElementById('whole_system').style.display = 'none'
            document.getElementById('auth').style.display = 'inline'
        })

        socket.on('join success', function(msg) {
            room = msg.room
            rid = msg.rid
            members = msg.members
            document.getElementById('rid').value = rid

            document.getElementById('room_info').innerHTML = "<h2>" + room + "</h2>"
            document.getElementById('members').innerHTML = '<h3>Current members in this room:</h3>'
            document.getElementById('members').innerHTML += '<ul>'
            var length = members.length;
            for (var i=0; i<length; i++) {
                document.getElementById('members').innerHTML += "<li>" + members[i]
            }

            document.getElementById('errormsg').innerHTML = ''
            document.getElementById('authpassword').value = ''
            document.getElementById('whole_system').style.display = 'none'
            document.getElementById('room').style.display = 'inline'
            document.getElementById('auth').style.display = 'none'
        });

        socket.on('auth fail', function() {
            document.getElementById('errormsg').innerHTML = '<p>Inaccurate Password</p>'
        })

        socket.on('exit success', function() {
            document.getElementById('room_box').innerHTML = ''
            document.getElementById('whole_system').style.display = 'inline'
            document.getElementById('room').style.display = 'none'
        })

        socket.on('user change', function(msg) {
              //socket.emit('my event', {'data': "entered if statement", 'time': new Date().format("yyyy-MM-dd hh:mm:ss")});
          document.getElementById("users").innerHTML = "<h3>Users currently online:</h3>";
          var length = msg.connected_users.length;
          document.getElementById('users').innerHTML += '<ul>'
          document.getElementById('users').innerHTML += "<li> <button onclick=set_partner('all')>Everyone</button>"
          for (var i=0; i<length; i++) {
            document.getElementById('users').innerHTML += "<li> <button onclick=set_partner(" + msg.connected_users[i]
            + ")>"+ msg.connected_users[i] + "</button>"
            //   var li = document.createElement("li")
            //   var button = document.createElement("BUTTON")
            //   button.scname=msg.connected_users[i]
            //   button.innerHTML += msg.connected_users[i]
            //   //button.onclick = set_partner(button.scname)
            //   li.innerHTML += button
            //   document.getElementById("users").appendChild(li);
            }
          document.getElementById('users').innerHTML += '</ul>';
        });

        //function set_partner(user) {
          //emit('set partner', user)
        //}

    });
</script>

<style type="text/css">
    #whole_system {
        position: absolute;
        display: block;
    }

    #room, #auth {
        position: absolute;
        display: none;
    }

    p {
        font-weight:bold;
    }

    #myDiv, #room_box {
        width: 300px; 
        height:200px; 
        overflow:scroll;
        overflow-x: hidden;
    }

    #users, #members {
        width: 300px;
        position: absolute;
        left: 1200px;
        top: 0px;
    }
    
    #chatting_room {
        width: 300px; 
        position: absolute;
        left: 900px;
        top: 0px;
        overflow-x: auto;
    }

    textarea {
        resize: none;
        width: 300px;
        height: 100px;
        border-color: grey;
        border-width: 2px;
        border-style: double;
    }
</style>

</head>

<body>
<h1><b>CN</b> Chat App</h1>

<div id=whole_system>
<div id="hello"></div>

<form action='/' method="GET">
<input type="submit" value="log out">
</form>

<!-- <form id="emit" action="#" method="POST">
<input type="text" name="scname" id="scname">
<input type="submit" value="Submit">
</form> -->

<form id="emit" action="#" method="POST">
    <textarea name="scname" id="scname"></textarea>
    <input type="submit" value="submit">
</form>


<div id="myDiv"></div>

<div id='users'>
<h3>Users currently online:</h3>
</div>

<div id='chatting_room'>
<h3>Current Chatting Rooms:</h3>
</div>

<h2>You can create new chatting room from here:</h2>
<form id="create" action="#" method="POST">
    Room Name:<br><input type="text" name="room_name" id="room_name" required><br>
    Room Description:<br><textarea name="description" id="description"></textarea><br>
    Room Password:<br>(If you put nothing here, it means this room is available to everybody)<br><input type="password" name="room_password" id="room_password"><br>
    <input type="submit" value="create">
</form>

</div>

<div id='room'>

<div id='welcome'></div>
<div id='room_info'></div>
<button id='exit_room' onclick='exit()'>Leave the room</button>
<input type='hidden' id='rid' name='rid'/>


<form id="room_emit" action="#" method="POST">
    <textarea name="room_text" id="room_text"></textarea>
    <input type="submit" value="submit">
</form>

<div id="room_box"></div>

<div id='members'></div>

</div>

<div id="auth">
<button id='back' onclick='back()'>Go back</button>
<h2>If you want to enter this room, please enter the password here:</h2>
<input type="password" name='authpassword' id='authpassword'>
<button id='into' onclick='into()'>Enter</button>
<input type='hidden' name='authrid' id='authrid'>
<div id='errormsg'></div>
</div>

</body>
</html>
